<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Echo Recall</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Tone.js for audio generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        /* Universal box-sizing for consistent layout */
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0b222c; /* Deep dark blue-green */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow-y: auto; /* Allow vertical scrolling if content overflows, for better debugging */
        }
        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
            background-color: #1a3a4a; /* Slightly lighter deep blue-green */
            border-radius: 1.5rem; /* Rounded corners for the container */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.4);
            max-width: 90vw; /* Responsive width */
            width: 500px; /* Max width on larger screens */
            box-sizing: border-box; /* Include padding in width */
        }
        .game-board {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* Two columns, equal width */
            grid-template-rows: repeat(2, 1fr);    /* Two rows, equal height - still useful for defining rows */
            gap: 1rem;
            width: 100%; /* Take full width of container */
            max-width: 400px; /* Max width for the grid itself */
            margin-top: 1.5rem;
        }
        .tile {
            width: 100%;
            padding-bottom: 100%; /* Makes height equal to width, creating squares based on width */
            position: relative; /* Needed for padding-bottom trick */
            background-color: #2b5568; /* Muted dark teal for default tiles */
            border-radius: 0.75rem; /* Rounded corners for tiles */
            cursor: pointer;
            transition: transform 0.1s ease-out, background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            display: flex; /* For centering content if any */
            justify-content: center;
            align-items: center;
        }
        .tile-content { /* No longer strictly needed as content is not added inside, but kept for future expansion */
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .tile:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
        }
        .tile.active {
            background-color: #ffffff; /* Bright white when active for strong visual feedback */
            box-shadow: 0 0 25px 8px rgba(255, 255, 255, 0.8); /* More intense glow */
            /* filter: brightness(1.2); Removed as background-color change is more direct */
        }
        /* Specific tile colors - apply after active to be overridden by active */
        .tile[data-color="red"] { background-color: #f472b6; } /* Tailwind pink-400 - more vibrant */
        .tile[data-color="blue"] { background-color: #38bdf8; } /* Tailwind sky-400 */
        .tile[data-color="green"] { background-color: #84cc16; } /* Tailwind lime-500 */
        .tile[data-color="yellow"] { background-color: #facc15; } /* Tailwind yellow-400 */

        .button-style {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: none; /* Remove default button border */
        }
        .button-primary {
            background-image: linear-gradient(to right top, #20c997, #17a2b8, #007bff); /* Teal-blue gradient */
            color: white;
        }
        .button-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.15);
        }
        .button-primary:active {
            transform: translateY(0);
            box-shadow: none;
        }
        .button-disabled {
            background-color: #4a5568; /* Gray-700 from new palette */
            color: #a0aec0; /* Gray-400 from new palette */
            cursor: not-allowed;
            opacity: 0.7;
            box-shadow: none;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s, opacity 0.3s ease-out;
        }
        .modal-overlay.show {
            visibility: visible;
            opacity: 1;
        }
        .modal-content {
            background-color: #1a3a4a; /* Matches game-container background */
            padding: 2.5rem;
            border-radius: 1rem;
            text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.6);
            color: white;
            max-width: 90%;
            width: 400px;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col justify-center items-center p-4">
    <div class="game-container">
        <h1 class="text-4xl font-bold mb-4 text-center text-teal-300">Echo Recall</h1>
        <p class="text-xl mb-4 text-center text-blue-200" id="instructions">
            Watch the sequence, then predict the *next* tile!
        </p>

        <div class="flex justify-between w-full max-w-sm mb-6">
            <div class="text-lg font-semibold text-blue-100">Level: <span id="level-display">0</span></div>
            <div class="text-lg font-semibold text-blue-100">Score: <span id="score-display">0</span></div>
        </div>

        <div class="game-board" id="game-board">
            <!-- Tiles will be dynamically generated here -->
        </div>

        <!-- The main share button is now removed from here -->
        <div class="flex flex-col sm:flex-row gap-4 mt-8 w-full justify-center">
            <button id="start-button" class="button-style button-primary">Start Game</button>
            <!-- Original share button removed from here, now it's in the modal -->
        </div>
    </div>

    <!-- Custom Modal for Game Over/Messages -->
    <div id="game-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="modal-title" class="text-3xl font-bold mb-4"></h2>
            <p id="modal-message" class="text-lg mb-6"></p>
            <!-- Buttons moved inside the modal-content -->
            <div class="flex flex-col sm:flex-row gap-4 mt-8 w-full justify-center">
                <button id="modal-close-button" class="button-style button-primary">Play Again</button>
                <button id="modal-share-button" class="button-style button-primary">Share Score</button>
            </div>
        </div>
    </div>

    <script>
        // Ensure the DOM is fully loaded before running the script
        window.onload = async function() {
            // Check if Tone.js is available
            if (typeof Tone === 'undefined') {
                console.error("Tone.js not loaded. Please check the script include.");
                document.getElementById('instructions').textContent = "Error: Audio library could not be loaded. Please try again.";
                return;
            }

            // --- Game State Variables ---
            const colors = ['red', 'blue', 'green', 'yellow'];
            let currentPattern = []; // The sequence of colors played in the current round
            let expectedNextGuess = ''; // The single color the player must predict
            let score = 0;
            let level = 0;
            let gameActive = false;
            let awaitingPlayerInput = false; // Flag to prevent input during sequence playback

            // --- DOM Elements ---
            const gameBoard = document.getElementById('game-board');
            const startButton = document.getElementById('start-button');
            const levelDisplay = document.getElementById('level-display');
            const scoreDisplay = document.getElementById('score-display');
            const instructionsText = document.getElementById('instructions');

            // Modal elements
            const gameModal = document.getElementById('game-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const modalCloseButton = document.getElementById('modal-close-button');
            const modalShareButton = document.getElementById('modal-share-button');

            // --- Tone.js Setup ---
            const synths = {};
            const baseNotes = {
                'red': 'C4',
                'blue': 'E4',
                'green': 'G4',
                'yellow': 'A4'
            };

            // Initialize synths for each color.
            const reverb = new Tone.Reverb({
                decay: 1.5,
                preDelay: 0.05,
                wet: 0.4
            }).toDestination();

            colors.forEach(color => {
                const synth = new Tone.PolySynth(Tone.Synth, {
                    oscillator: { type: 'sine' },
                    envelope: { attack: 0.005, decay: 0.1, sustain: 0.2, release: 1 }
                }).connect(reverb);
                synths[color] = synth;
            });

            // Ensure Tone.js audio context is started by user interaction
            document.documentElement.addEventListener('mousedown', () => {
                if (Tone.context.state !== 'running') { Tone.start(); console.log("Audio context started."); }
            });
            document.documentElement.addEventListener('touchstart', () => {
                if (Tone.context.state !== 'running') { Tone.start(); console.log("Audio context started."); }
            });


            // --- Game Functions ---

            // Create the game tiles dynamically
            function createTiles() {
                gameBoard.innerHTML = ''; // Clear existing tiles
                colors.forEach(color => {
                    const tile = document.createElement('div');
                    tile.classList.add('tile');
                    tile.dataset.color = color;
                    tile.addEventListener('click', () => handleTileClick(color));
                    gameBoard.appendChild(tile);
                });
            }

            // Lights up a tile and plays its corresponding tone
            async function activateTile(color, duration = 300) {
                const tile = gameBoard.querySelector(`.tile[data-color="${color}"]`);
                if (tile) {
                    console.log(`Activating tile: ${color}`);
                    tile.classList.add('active');
                    synths[color].triggerAttackRelease(baseNotes[color], "8n");
                    await new Promise(resolve => setTimeout(resolve, duration));
                    tile.classList.remove('active');
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
            }

            // Plays the entire current pattern
            async function playPattern() {
                awaitingPlayerInput = false;
                instructionsText.textContent = "Watch carefully...";
                startButton.disabled = true;
                startButton.classList.add('button-disabled');

                await new Promise(resolve => setTimeout(resolve, 700));

                for (let i = 0; i < currentPattern.length; i++) {
                    console.log(`Playing pattern step ${i}: ${currentPattern[i]}`);
                    await activateTile(currentPattern[i], 450);
                    await new Promise(resolve => setTimeout(resolve, 200));
                }

                instructionsText.textContent = "Your turn! Which tile is NEXT?";
                awaitingPlayerInput = true;
            }

            // Handles player's tile click
            async function handleTileClick(clickedColor) {
                if (!gameActive || !awaitingPlayerInput) {
                    return;
                }

                const tile = gameBoard.querySelector(`.tile[data-color="${clickedColor}"]`);
                if (tile) {
                    tile.classList.add('active');
                    synths[clickedColor].triggerAttackRelease(baseNotes[clickedColor], "32n");
                    await new Promise(resolve => setTimeout(resolve, 100));
                    tile.classList.remove('active');
                }

                if (clickedColor === expectedNextGuess) {
                    instructionsText.textContent = "Correct! Get ready for the next sequence.";
                    score += 100;
                    scoreDisplay.textContent = score;

                    await new Promise(resolve => setTimeout(resolve, 1000));
                    startRound();
                } else {
                    gameOver();
                }
            }

            // Initializes a new game round
            async function startRound() {
                awaitingPlayerInput = false;
                level++;
                levelDisplay.textContent = level;

                expectedNextGuess = colors[Math.floor(Math.random() * colors.length)];
                currentPattern.push(expectedNextGuess);
                console.log("Current pattern for this round:", currentPattern);
                console.log("Expected next guess:", expectedNextGuess);

                await playPattern();
            }

            // Resets the game to its initial state
            function initializeGame() {
                currentPattern = [];
                expectedNextGuess = '';
                score = 0;
                level = 0;
                gameActive = false;
                awaitingPlayerInput = false;

                levelDisplay.textContent = level;
                scoreDisplay.textContent = score;
                instructionsText.textContent = "Watch the sequence, then predict the *next* tile!";
                startButton.textContent = "Start Game";
                startButton.disabled = false;
                startButton.classList.remove('button-disabled');

                hideModal();
            }

            // Ends the game
            function gameOver() {
                gameActive = false;
                awaitingPlayerInput = false;
                instructionsText.textContent = "Game Over!";
                startButton.textContent = "Play Again";
                startButton.disabled = false;
                startButton.classList.remove('button-disabled');

                const synthFail = new Tone.MembraneSynth().toDestination();
                synthFail.triggerAttackRelease("C2", "2n");
                synthFail.triggerAttackRelease("G#1", "2n", "+0.2");

                showModal(`Game Over!`, `You reached Level ${level} with a score of ${score}.`);
            }

            // --- Modal Functions ---
            function showModal(title, message) {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                gameModal.classList.add('show');
            }

            function hideModal() {
                gameModal.classList.remove('show');
            }

            // --- Event Listeners ---
            startButton.addEventListener('click', () => {
                if (!gameActive) {
                    gameActive = true;
                    startButton.textContent = "Playing...";
                    startButton.disabled = true;
                    startButton.classList.add('button-disabled');
                    startRound();
                }
            });

            modalCloseButton.addEventListener('click', () => {
                hideModal();
                initializeGame();
            });

            modalShareButton.addEventListener('click', () => {
                const shareText = `I scored ${score} and reached Level ${level} in Echo Recall! Can you beat me? Try it here: ${window.location.href} #EchoRecallGame`;

                console.log('Attempting to copy score and link to clipboard.');
                const tempInput = document.createElement('textarea');
                tempInput.value = shareText;
                tempInput.style.position = 'absolute';
                tempInput.style.left = '-9999px';
                tempInput.style.top = '0';
                document.body.appendChild(tempInput);
                tempInput.select();
                let copySuccessful = false;
                try {
                    copySuccessful = document.execCommand('copy');
                    if (copySuccessful) {
                        console.log('Clipboard copy successful.');
                        // Display a concise message in the modal
                        showModal('Score Copied!', `Your score has been copied to your clipboard. Now paste it anywhere to share your score and the game link!`);
                    } else {
                        console.error('Clipboard copy failed (execCommand returned false).');
                        showModal('Copy Failed', 'Could not copy score automatically. Please manually copy the text below:\n\n' + shareText);
                    }
                } catch (err) {
                    console.error('Failed to copy text using execCommand: ', err);
                    showModal('Copy Failed', 'Could not copy score. Please manually copy the text below:\n\n' + shareText);
                } finally {
                    document.body.removeChild(tempInput);
                }
            });

            // --- Initial Setup on Window Load ---
            createTiles();
            initializeGame();
        };
    </script>
</body>
</html>
